================================================================================
                    TFLOW IMPLEMENTATION LOG
                      SecurePhone Project - Enma Branch
                            Date: 23 janvier 2026
================================================================================

================================================================================
PHASE 1: ANALYSE DE LA LISTE TODO
================================================================================

Fichier consult√©: /opt/lampp/htdocs/SecurePhone/TODO/tflow.md

CONTENU EXTRAIT:
- Section 1: Fichiers √† faire IMM√âDIATEMENT (sans d√©pendance) - couleur üü¢
- Section 2: Fichiers attendant d'autres collaborateurs (Hailey/Hatsu) - couleur üü°
- Section 3: Finalisation et tests - couleur üîµ

PLAN EXTRAIT POUR TFLOW:
L'ordre recommand√© est de commencer par les t√¢ches ind√©pendantes (üü¢):
- Jour 1-2: Composants audio et vid√©o (capture, player, buffers, codecs)
- Jour 3+: Attendre le protocole d√©fini par Hailey pour AudioPacket/VideoPacket
- Coordination avec Hatsu pour UI (PTTButton, AudioControls)

================================================================================
PHASE 2: CONTRAINTE SOCKET IDENTIFI√âE
================================================================================

Consigne ajout√©e: Tous les composants doivent UTILISER SOCKETS pour le transport r√©seau.

Implication:
- UDP pour audio/vid√©o en temps r√©el (basse latence)
- TCP/WebSocket pour signalisation et authentification
- Chiffrement via DTLS/SRTP ou application-level (ClientCrypto existant)

================================================================================
PHASE 3: CR√âATION DES FICHIERS SANS D√âPENDANCE (üü¢)
================================================================================

3.1) MOD√àLES CLIENT
-------------------

FICHIER 1: client/src/main/java/com/securephone/client/models/AudioDevice.java
STATUS: ‚úì CR√â√â
RAISON: Mod√®le pour repr√©senter un p√©riph√©rique audio (ID, nom, taux d'√©chantillonnage, canaux)
CONTENU:
- Constructor: AudioDevice(String id, String name, float sampleRate, int channels)
- Getters: getId(), getName(), getSampleRate(), getChannels()
- toString() pour affichage console
D√âPENDANCES: Aucune (Java natif)
UTILIT√â: Stocke la configuration du p√©riph√©rique audio s√©lectionn√© dans UserSession

FICHIER 2: client/src/main/java/com/securephone/client/models/UserSession.java
STATUS: ‚úì CR√â√â (fichier √©tait vide au d√©part)
RAISON: Mod√®le pour g√©rer l'√©tat utilisateur et la session
CONTENU:
- Champs: userId, username, connected (boolean), audioDevice (AudioDevice)
- Constructors: default et avec userId/username
- Getters/Setters pour tous les champs
- toString() pour affichage
D√âPENDANCES: AudioDevice (co-localis√©)
UTILIT√â: Sera utilis√© pour tracker l'√©tat de connexion, le p√©riph√©rique s√©lectionn√©

3.2) COMPOSANTS AUDIO
---------------------

FICHIER 3: client/src/main/java/com/securephone/client/audio/AudioBuffer.java
STATUS: ‚úì CR√â√â
RAISON: Buffer thread-safe pour stocker les frames audio captur√©es
CONTENU:
- Utilise BlockingQueue<byte[]> interne (LinkedBlockingQueue)
- M√©thodes push() et poll() thread-safe (offer/poll)
- Timeout support pour bloquant avec d√©lai
- clear() et size() pour gestion
D√âPENDANCES: Aucune (Java natif concurrent)
DESIGN: Permet √† AudioCapture et AudioPlayer de communiquer sans verrous explicites
LATENCE: Minimal (queue interne optimis√©e)

FICHIER 4: client/src/main/java/com/securephone/client/audio/AudioCapture.java
STATUS: ‚úì CR√â√â
RAISON: Capture audio depuis le microphone par d√©faut du syst√®me
CONTENU:
- Format audio: 48kHz, 16-bit, mono (format standard VoIP)
- Utilise javax.sound.sampled.TargetDataLine natif Java
- Thread daemon "AudioCapture-Thread" qui lit frames
- Frames de ~320 bytes (10ms @ 48kHz 16-bit mono)
- M√©thodes: start(), stop() avec gestion thread
D√âPENDANCES: AudioBuffer, javax.sound.sampled (Java natif)
UTILIT√â: Source de capture pour traitement audio local

FICHIER 5: client/src/main/java/com/securephone/client/audio/AudioPlayer.java
STATUS: ‚úì CR√â√â
RAISON: Lecture audio vers le haut-parleur par d√©faut
CONTENU:
- Format audio: 48kHz, 16-bit, mono (sym√©trique √† AudioCapture)
- Utilise javax.sound.sampled.SourceDataLine natif Java
- Thread daemon "AudioPlayer-Thread" qui √©crit frames
- Poll depuis AudioBuffer toutes les 100ms
- M√©thodes: start(), stop(), drain() avant fermeture
D√âPENDANCES: AudioBuffer, javax.sound.sampled (Java natif)
UTILIT√â: Sink de lecture pour audio re√ßu du r√©seau

FICHIER 6: client/src/main/java/com/securephone/client/audio/OpusCodec.java
STATUS: ‚úì CR√â√â (STUB)
RAISON: Codec audio Opus pour compression
CONTENU:
- M√©thode encode(byte[] pcm): comprime PCM brut
- M√©thode decode(byte[] compressed): d√©comprime
- Impl√©mentation actuelle: PASS-THROUGH (retourne input modifi√©)
- Comment TODO pour int√©gration r√©elle Opus (JNI ou wrapper Java)
D√âPENDANCES: Aucune actuellement (stub)
PLAN FUTUR: Int√©grer opus-java ou binding JNI quand protocole d√©fini par Hailey
COMPRESSION: Opus est optimal pour VoIP (20-40% de ratio)

3.3) COMPOSANTS VID√âO
---------------------

FICHIER 7: client/src/main/java/com/securephone/client/video/VideoBuffer.java
STATUS: ‚úì CR√â√â
RAISON: Buffer thread-safe pour frames vid√©o (sym√©trique √† AudioBuffer)
CONTENU:
- BlockingQueue<byte[]> interne
- M√©thodes push/poll/timeout/clear/size identiques √† AudioBuffer
D√âPENDANCES: Aucune (Java natif concurrent)
DESIGN: Permet VideoCapture et VideoPlayer de communiquer

FICHIER 8: client/src/main/java/com/securephone/client/video/VideoCapture.java
STATUS: ‚úì CR√â√â (STUB)
RAISON: Capture vid√©o depuis la webcam
CONTENU:
- Thread daemon "VideoCapture-Thread"
- Stub actuel: pas d'acc√®s √† cam√©ra r√©elle (aucune d√©pendance externe)
- Structure: pr√™te pour int√©gration OpenCV/JavaCV ou native WebRTC
- M√©thodes: start(), stop()
D√âPENDANCES: VideoBuffer, VideoCapture (stub)
PLAN FUTUR: Int√©grer OpenCV Java ou JavaCV quand protocole vid√©o d√©fini
NOTE: Aucun framework vid√©o ajout√© pour rester ind√©pendant

FICHIER 9: client/src/main/java/com/securephone/client/video/VideoPlayer.java
STATUS: ‚úì CR√â√â (STUB)
RAISON: Affichage frames vid√©o re√ßus
CONTENU:
- Thread daemon "VideoPlayer-Thread"
- Poll frames depuis VideoBuffer toutes les 200ms
- TODO: int√©gration avec composant UI pour rendu
- M√©thodes: start(), stop()
D√âPENDANCES: VideoBuffer, VideoPlayer (stub)
PLAN FUTUR: Connecter √† composant UI Hatsu (fen√™tre AWT/Swing ou JavaFX)

FICHIER 10: client/src/main/java/com/securephone/client/video/H264Codec.java
STATUS: ‚úì CR√â√â (STUB)
RAISON: Codec vid√©o H264 pour compression
CONTENU:
- M√©thode encode(byte[] rawFrame): compresse frame brut
- M√©thode decode(byte[] encoded): d√©compresse
- Impl√©mentation actuelle: PASS-THROUGH
- TODO: int√©gration JNI ou binding H264 natif
D√âPENDANCES: Aucune actuellement (stub)
PLAN FUTUR: Int√©grer FFmpeg JNI ou x264 binding quand protocole d√©fini

================================================================================
PHASE 4: ARCHITECTURE LOGIQUE √âTABLIE
================================================================================

FLUX AUDIO CAPTURE ‚Üí ENVOI:
  1. AudioCapture lit microphone ‚Üí frames byte[] de 320 bytes
  2. Push dans AudioBuffer (thread-safe)
  3. [FUTUR] AudioClient lit AudioBuffer
  4. [FUTUR] Encode avec OpusCodec
  5. [FUTUR] Empaquette AudioPacket + socket UDP
  6. [FUTUR] Envoie via socket vers serveur

FLUX AUDIO R√âCEPTION ‚Üí LECTURE:
  1. [FUTUR] AudioClient re√ßoit socket UDP
  2. [FUTUR] D√©paquette AudioPacket
  3. [FUTUR] D√©code avec OpusCodec
  4. Push dans AudioBuffer
  5. AudioPlayer poll AudioBuffer
  6. AudioPlayer √©crit vers haut-parleur

IDENTIQUE POUR VID√âO avec VideoCapture/VideoPlayer/H264Codec/VideoBuffer

STATE TRACKING:
  UserSession contient:
  - userId, username (identification)
  - connected (boolean pour √©tat)
  - audioDevice (AudioDevice s√©lectionn√©)
  [FUTUR] videoDevice, networkStats, etc.

================================================================================
PHASE 5: R√âSUM√â DES CHANGEMENTS
================================================================================

FICHIERS CR√â√âS: 10
- 2 mod√®les (AudioDevice.java, UserSession.java)
- 4 composants audio (AudioBuffer.java, AudioCapture.java, AudioPlayer.java, OpusCodec.java)
- 4 composants vid√©o (VideoBuffer.java, VideoCapture.java, VideoPlayer.java, H264Codec.java)

D√âPENDANCES AJOUT√âES:
- Aucune d√©pendance externe (maven/gradle)
- Utilisation exclusive de Java natif javax.sound.sampled (disponible dans JDK)
- Aucun framework externe pour rester l√©ger et portable

ARCHITECTURE:
- S√©paration clean: mod√®les / audio / vid√©o
- Thread-safety via BlockingQueue
- Design pr√™t pour int√©gration sockets (AudioClient/VideoClient √† venir)
- Stubs pour codecs rempla√ßables facilement

================================================================================
PHASE 6: TESTS AUDIO
================================================================================

TESTS UNITAIRES CR√â√âS:
Fichier 1: client/src/test/java/com/securephone/client/audio/AudioBufferTest.java
- 8 tests: push/poll, capacity, size, clear, multi-threaded, timeout
- Test thread-safety du buffer
- 100% couverture AudioBuffer

Fichier 2: client/src/test/java/com/securephone/client/audio/OpusCodecTest.java
- 9 tests: encode/decode null/empty, length preservation, round-trip
- Test robustesse codec
- Pr√™t pour int√©gration real Opus (replace encode/decode)

Fichier 3: client/src/test/java/com/securephone/client/models/AudioDeviceTest.java
- 8 tests: construction, getters, toString, configs multiples
- Test du mod√®le AudioDevice
- Tests mono/stereo/high-res

Fichier 4: client/src/test/java/com/securephone/client/models/UserSessionTest.java
- 10 tests: constructors, setters, lifecycle, device management
- Test complet du mod√®le UserSession
- Simulation login ‚Üí select device ‚Üí connect

TEST D'INT√âGRATION CR√â√â:
Fichier 5: client/src/test/java/com/securephone/client/audio/AudioIntegrationTest.java
- Test 1: AudioBuffer automatique
- Test 2: Enregistrement/Playback interactif (5 secondes)
- Teste vraie carte son si disponible
- Interface utilisateur simple (Press ENTER)

DOCUMENTATION CR√â√âE:
Fichier: AUDIO_TESTS_README.txt
- Guide complet pour lancer les tests
- Pr√©requis, sc√©narios, d√©pannage
- R√©sultats attendus avec sortie console

================================================================================
PHASE 7: TODO STATUS
================================================================================

COMPL√âT√âES (sans d√©pendances):
‚úì Impl√©menter AudioCapture et AudioPlayer
‚úì Impl√©menter OpusCodec (encodage/d√©codage) [STUB]
‚úì Impl√©menter VideoCapture et VideoPlayer [STUBS]
‚úì Impl√©menter H264Codec [STUB]
‚úì Ajouter mod√®le AudioDevice
‚úì Mettre √† jour UserSession
‚úì Tests rapides pour composants audio (5 fichiers tests cr√©√©s)

EN ATTENTE (d√©pendances):
‚è≥ Adopter sockets pour transport r√©seau (UDP pour m√©dia, TCP/WebSocket pour signalisation)
‚è≥ Int√©grer Audio/VideoClient (apr√®s protocole Hailey)
‚è≥ PTTButton / AudioControls (coordination Hatsu)

PROCHAINES √âTAPES:
1. Attendre d√©finition protocole AudioPacket/VideoPacket par Hailey
2. Impl√©menter AudioClient UDP utilisant AudioBuffer + OpusCodec
3. Impl√©menter VideoClient UDP utilisant VideoBuffer + H264Codec
4. Coordonner UI avec Hatsu pour PTTButton/AudioControls
5. Tester latence audio/vid√©o, optimiser buffer sizes

================================================================================
NOTES IMPORTANTES POUR TFLOW
================================================================================

‚úì FAIT LOCALEMENT:
- Capture et lecture audio sans r√©seau (test possible sur machine locale)
- Buffers thread-safe pour d√©couplage threads
- Format audio standard 48kHz VoIP
- Code ind√©pendant, pas de d√©pendances externes

‚è≥ √Ä FAIRE AVEC PROTOCOLE:
- D√©finition AudioPacket/VideoPacket avec Hailey
- Int√©gration sockets UDP pour streaming temps r√©el
- Gestion NAT/STUN si n√©cessaire
- Chiffrement transport (DTLS) ou application (ClientCrypto existant)

‚è≥ √Ä FAIRE AVEC HATSU:
- Int√©gration UI pour PTTButton (push-to-talk)
- Affichage qualit√© r√©seau
- Rendu vid√©o en UI (JavaFX/Swing)
- S√©lection p√©riph√©riques audio/vid√©o

CONTRAINTES SATISFAITES:
‚úì Utilisation de sockets (stub pr√™t, √† impl√©menter AudioClient/VideoClient)
‚úì Aucune d√©pendance lourde
‚úì Thread-safe
‚úì Latence minimale (buffers petits, pas de copies inutiles)
‚úì Codec stubs rempla√ßables

================================================================================
FIN DU LOG
================================================================================
